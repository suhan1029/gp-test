<!-- templates/index.html -->
{% extends "base.html" %}

{% block content %}
<div class="content">
    <div class="horizontal-line"></div>
    <h1 class="header">Personal Color Diagnosis</h1>
    <p class="subheader">Upload your image or take a photo for diagnosis</p>
    <form id="upload-form" action="/personal_color" method="post" enctype="multipart/form-data" onsubmit="return checkFileUpload(event)">
        <label for="file-input" class="file-input-label">
            Choose an image
        </label>
        <input type="file" id="file-input" name="file" accept="image/*" onchange="previewFile(event)" class="file-input">
        <span id="file-name"></span>
        <br>
        <button type="button" id="start-camera" class="file-input-label">사진찍기</button>
        <div id="camera-container" style="display:none;">
            <video id="video" width="640" height="480" autoplay></video>
            <button type="button" id="capture-photo">Capture Photo</button>
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="preview">
        <br>
        <input type="submit" value="Upload Image to AI" class="upload-button" style="margin-top: 20px;">
    </form>
</div>

<script>
    let video = null;
    let canvas = null;
    let photo = null;

    document.addEventListener('DOMContentLoaded', function() {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        photo = document.getElementById('preview');

        document.getElementById('start-camera').addEventListener('click', function(ev){
            ev.preventDefault();
            document.getElementById('camera-container').style.display = 'block';
            navigator.mediaDevices.getUserMedia({video: true, audio: false})
            .then(function(stream) {
                video.srcObject = stream;
                video.play();
            })
            .catch(function(err) {
                console.log("An error occurred: " + err);
            });
        }, false);

        document.getElementById('capture-photo').addEventListener('click', function(ev){
            ev.preventDefault();
            takePicture();
            stopVideoStream();
        }, false);
    });

    function stopVideoStream() {
        const stream = video.srcObject;
        const tracks = stream.getTracks();

        tracks.forEach(function(track) {
            track.stop();
        });

        video.srcObject = null;
        document.getElementById('camera-container').style.display = 'none';
    }

    function takePicture() {
        const context = canvas.getContext('2d');
        if (video.videoWidth && video.videoHeight) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

            const dataURL = canvas.toDataURL('image/png');
            photo.setAttribute('src', dataURL);
            photo.style.display = 'block';

            // Convert dataURL to Blob and store it for form submission
            dataURLToBlob(dataURL, function(blob) {
                // Append blob to form data
                const file = new File([blob], 'webcam.png', {type: 'image/png'});
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('file-input').files = dataTransfer.files;
            });

            document.getElementById('file-name').textContent = `Captured Image: webcam.png`;
        } else {
            clearPhoto();
        }
    }

    function clearPhoto() {
        const context = canvas.getContext('2d');
        context.fillStyle = "#AAA";
        context.fillRect(0, 0, canvas.width, canvas.height);

        const data = canvas.toDataURL('image/png');
        photo.setAttribute('src', data);
    }

    function dataURLToBlob(dataURL, callback) {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', dataURL);
        xhr.responseType = 'blob';
        xhr.onload = function() {
            callback(xhr.response);
        };
        xhr.send();
    }

    function previewFile(event) {
        const input = event.target;
        const fileName = input.files[0].name;
        document.getElementById('file-name').textContent = `Selected file: ${fileName}`;

        const reader = new FileReader();
        reader.onload = function(){
            const preview = document.getElementById('preview');
            preview.src = reader.result;
            preview.style.display = 'block';
        }
        reader.readAsDataURL(input.files[0]);
    }

    function checkFileUpload(event) {
        const input = document.getElementById('file-input');
        if (input.files.length === 0) {
            event.preventDefault(); // 폼 제출을 막음
            alert('파일을 선택해주세요.');
            return false;
        } 
        return true;
    }
</script>
{% endblock %}
